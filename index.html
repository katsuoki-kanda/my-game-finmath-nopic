<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Math Game v3.0 - Black Background Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background: #000; font-family: 'Arial Black', sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        #container { position: relative; width: 100%; height: 100%; max-width: 1280px; max-height: 720px; background: #000; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; color: #0f0; text-shadow: 4px 4px #000;
            padding: 30px; box-sizing: border-box;
            z-index: 10;
        }

        .hud { font-size: 48px; font-weight: bold; margin-bottom: 5px; }
        #time-text { color: #fff; }
        
        #status-text {
            position: absolute;
            top: 130px; 
            left: 0;
            font-size: 40px; 
            color: #0f0; 
            text-align: center; 
            width: 100%;
        }

        #question-area {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            text-align: center; 
            width: 100%;
        }
        .main-q { 
            font-size: 300px; color: #f00; font-weight: bold; 
            -webkit-text-stroke: 8px #00f;
            letter-spacing: -10px;
            line-height: 1; 
        }

        .correct-circle {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 400px; 
            height: 400px; 
            border: 40px solid #f00; 
            border-radius: 50%; 
            display: none;
            box-shadow: 0 0 20px #000; 
        }

        .footer-hint {
            position: absolute; bottom: 20px; left: 20px; color: #aaa; font-size: 20px;
        }
    </style>
</head>
<body>

<div id="container">
    <video id="input_video" style="display:none;" playsinline></video>
    <canvas id="output_canvas"></canvas>
    <div id="ui-layer">
        <div class="hud" id="score-text">Score: 0</div>
        <div class="hud" id="time-text">Time: 60</div>
        
        <div id="status-text">カメラを読み込み中...</div>
        
        <div id="question-area">
            <div id="main-q" class="main-q"></div>
            <div id="correct-circle" class="correct-circle"></div>
        </div>

        <div class="footer-hint">
            [1]:音声 [2]:表示 [F]:全画面 [Enter]:リスタート
        </div>
    </div>
</div>

<script>
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const scoreText = document.getElementById('score-text');
    const timeText = document.getElementById('time-text');
    const statusText = document.getElementById('status-text');
    const mainQ = document.getElementById('main-q');
    const correctCircle = document.getElementById('correct-circle');

    let score = 0;
    let timeLeft = 60;
    let gameStarted = false;
    let isWaitingStartVoice = false; 
    let voiceMode = 0;
    let currentAns = 0;
    let lastAns = 0; 
    let seiCount = 0;
    let startTime = 0;
    
    let lastHandCount = 0;
    let handStableTime = 0;
    const DETECTION_DELAY = 0; 

    const synth = window.speechSynthesis;

    // 【修正】AudioContextをグローバルで管理
    let audioCtx = null;

    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function speak(text, callback) {
        if (!text) return;
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP';
        if (callback) {
            uttr.onend = callback;
        }
        synth.cancel(); // 詰まり防止
        synth.speak(uttr);
    }

    function beep() {
        // 【修正】発音前にコンテキストを有効化
        initAudioContext();
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        
        osc.type = 'sine';
        osc.frequency.setValueAtTime(700, audioCtx.currentTime);
        
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        osc.start(now);
        gain.gain.setValueAtTime(1, now);
        // 指数関数的な減衰でノイズを防止
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.1);
        osc.stop(now + 0.12);
    }

    function initGame() {
        if (isWaitingStartVoice) return; 
        
        // 【修正】ユーザー操作（手上げ検知）に同期してオーディオを初期化
        initAudioContext();

        gameStarted = false;
        isWaitingStartVoice = true;
        score = 0;
        timeLeft = 60;
        lastAns = 0; 
        scoreText.textContent = `Score: ${score}`;
        timeText.textContent = `Time: ${timeLeft}`;
        statusText.textContent = "まもなく開始...";
        mainQ.textContent = "";

        speak("スタート", () => {
            isWaitingStartVoice = false;
            gameStarted = true;
            startTime = Date.now();
            statusText.textContent = ""; 
            generateQuestion();
        });
    }

    function generateQuestion() {
        let n1, n2, newAns, op;
        const operators = ['+', '-'];
        
        do {
            n1 = Math.floor(Math.random() * 9) + 1; // 1~9
            n2 = Math.floor(Math.random() * 9) + 1; // 1~9
            op = operators[Math.floor(Math.random() * operators.length)];
            
            if (op === '+') {
                newAns = n1 + n2;
            } else {
                newAns = n1 - n2;
            }
        } while (newAns < 1 || newAns > 10 || newAns === lastAns);

        currentAns = newAns;
        lastAns = currentAns; 
        
        const opText = op === '+' ? "たす" : "ひく";
        
        if (voiceMode === 1) {
            mainQ.textContent = "? ? ?";
            speak(`${n1}${opText}${n2}`);
        } else {
            mainQ.textContent = `${n1}${op}${n2}`;
        }
    }

    function onResults(results) {
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        
        let rightHandFingers = 0;
        let leftHandFingers = 0;
        let handsDetectedCount = 0;
        let detectedLabels = new Set();

        if (results.multiHandLandmarks && results.multiHandedness) {
            for (let i = 0; i < results.multiHandLandmarks.length; i++) {
                const landmarks = results.multiHandLandmarks[i];
                const label = results.multiHandedness[i].label;

                if (landmarks[0].y > 0.85) continue;

                if (detectedLabels.has(label)) continue;
                detectedLabels.add(label);
                handsDetectedCount++;

                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});

                let count = 0;
                if (label === 'Right' ? landmarks[4].x < landmarks[3].x : landmarks[4].x > landmarks[3].x) count++;
                [8, 12, 16, 20].forEach(idx => {
                    if (landmarks[idx].y < landmarks[idx - 2].y) count++;
                });

                if (label === 'Right') rightHandFingers = count;
                else leftHandFingers = count;

                if (!gameStarted && !isWaitingStartVoice && landmarks[0].y < 0.3) {
                    initGame();
                }
            }
        }

        const now = Date.now();
        if (handsDetectedCount !== lastHandCount) {
            handStableTime = now;
            lastHandCount = handsDetectedCount;
        }

        const isStable = (now - handStableTime) > DETECTION_DELAY;
        const totalFingers = rightHandFingers + leftHandFingers;

        if (gameStarted) {
            const elapsed = Math.floor((now - startTime) / 1000);
            timeLeft = Math.max(0, 60 - elapsed);
            timeText.textContent = `Time: ${timeLeft}`;

            if (timeLeft <= 0) {
                gameStarted = false;
                mainQ.textContent = "終了";
                speak(`${score}点です。終了。`);
                statusText.textContent = "Enterキーでリスタート";
            }

            const isCorrectSum = (totalFingers === currentAns);
            const handCondition = (currentAns > 5) ? (handsDetectedCount === 2) : (handsDetectedCount >= 1);

            if (isCorrectSum && handCondition && isStable && seiCount === 0 && timeLeft > 0) {
                score++;
                scoreText.textContent = `Score: ${score}`;
                beep();
                seiCount = 1;
                correctCircle.style.display = "block";
                mainQ.textContent = currentAns;
                
                setTimeout(() => {
                    correctCircle.style.display = "none";
                    seiCount = 0;
                    if (gameStarted) generateQuestion();
                }, 700);
            }
        } else if (timeLeft > 0 && !isWaitingStartVoice) {
            statusText.textContent = "片手を高く挙げるとスタート！";
            mainQ.textContent = ""; 
        }
        canvasCtx.restore();
    }

    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });
    hands.setOptions({ 
        maxNumHands: 2, 
        modelComplexity: 1, 
        minDetectionConfidence: 0.7, 
        minTrackingConfidence: 0.7 
    });
    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280, height: 720
    });
    camera.start();

    window.addEventListener('keydown', (e) => {
        if (e.key === '1') { speak("音声モード"); voiceMode = 1; if(gameStarted) generateQuestion(); }
        if (e.key === '2') { speak("表示モード"); voiceMode = 0; if(gameStarted) generateQuestion(); }
        if (e.key === 'f') {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }
        if (e.key === 'Enter') {
            initGame();
        }
    });

    // 最初のタップで各種オーディオをアンロック
    window.addEventListener('click', () => {
        initAudioContext();
        speak("");
    }, { once: true });

    function resize() {
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();
</script>
</body>
</html>